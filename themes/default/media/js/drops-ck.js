/**
 * Drops module
 */(function(e){Drops=e.Drops={};var t=Backbone.Model.extend(),n=Backbone.Collection.extend({model:t,comparator:function(e){return parseInt(e.get("id"))}}),r=Backbone.View.extend({tagName:"article",className:"drop base cf",events:{mouseover:function(){this.$(".drop-body p.remove-small").show()},mouseout:function(){this.$(".drop-body p.remove-small").hide()},"click p.remove-small":"delete"},initialize:function(e){this.template=_.template($("#discussion-template").html())},render:function(e){this.$el.html(this.template(this.model.toJSON()));return this},"delete":function(){(new ConfirmationWindow("Delete this comment?",function(){model=this.model;view=this;model.save({comment_text:"This comment has been removed",deleted:!0},{wait:!0,success:function(){view.render()},error:function(){showConfirmationMessage("Unable to delete comment. Try again later.")}})},this)).show();return!1}}),i=Backbone.Model.extend(),s=Backbone.Collection.extend({model:i}),o=Backbone.Model.extend(),u=Backbone.Collection.extend({model:o}),a=Backbone.Model.extend(),f=Backbone.Collection.extend({model:a}),l=Drops.Drop=Backbone.Model.extend({initialize:function(){if(this.get("droplet_image")!=undefined){this.get("droplet_image").thumbnails!=undefined&&this.get("droplet_image").thumbnails["200"]!=undefined&&this.set("droplet_image_url",this.get("droplet_image").thumbnails[200]);this.has("droplet_image_url")||this.set("droplet_image_url",site_url+"media/thumb/?src="+encodeURIComponent(this.get("droplet_image").url)+"&w=200")}},setBucket:function(e){buckets=_.clone(this.get("buckets"));buckets==null&&(buckets=[]);bucketId=e.get("id");var t="";if(this.isInBucket(e)){buckets=_.filter(buckets,function(e){return e["id"]!=bucketId});t="remove"}else{buckets.push({id:bucketId,name:e.get("name")});t="add"}this.save({buckets:buckets,command:t,bucket_id:bucketId},{patch:!0,wait:!0})},isInBucket:function(e){return _.any(this.get("buckets"),function(t){return t["id"]==e.get("id")})},score:function(e){var t=e-this.get("user_score");t>1?t=1:t<-1&&(t=-1);this.save({user_score:t,droplet_score:{user_score:t,user_id:window.logged_in_user}})}}),c=Drops.DropsList=Backbone.Collection.extend({model:l,comparator:function(e){return Date.parse(e.get("date_published"))},add:function(e,t){var n=this.length==0;Backbone.Collection.prototype.add.call(this,e,t);if(!n){var r=[];dropsList=this;_.each(e,function(e){r.push(dropsList.get(e.id))});this.trigger("drops",r)}},getUnread:function(){return this.filter(function(e){return!e.get("read")})},getRead:function(){return this.filter(function(e){return e.get("read")})}}),h=Backbone.View.extend({showAddToBucketModal:function(){var e=new m({collection:Assets.bucketList,model:this.model});modalShow(e.render().el);return!1},showDropScore:function(e){var t=this.$(e);t.toggleClass("selected");t.hasClass("selected")&&t.siblings("li").removeClass("selected")},likeDrop:function(){this.model.score(1);return!1},dislikeDrop:function(){this.model.score(-1);return!1},updateDropScore:function(){new_score=this.model.get("user_score");old_score=this.model.previous("user_score");new_score==1||new_score==0&&old_score==1?this.showDropScore("ul.score-drop > li.star"):(new_score==-1||new_score==0&&old_score==-1)&&this.showDropScore("ul.score-drop > li.remove")},shareDrop:function(){if(!window.public_registration_enabled)showConfirmationMessage("Drop sharing is not allowed in this deployment");else{shareView=new T({model:this.model,baseURL:this.options.baseURL});modalShow(shareView.render().el)}return!1},updateBucketCount:function(){var e=this.model.get("buckets").length,t=this.$(".bucket .bucket-total");t.html(e);e>0?t.show():t.hide()}}),p=h.extend({events:{"click a.zoom-trigger":"showDetail","click p.discussion a":"showDetail","click li.bucket a.modal-trigger":"showAddToBucketModal","click ul.score-drop > li.star a":"likeDrop","click ul.score-drop > li.remove a":"dislikeDrop","click li.share > a":"shareDrop"},initialize:function(e){var t=null;if(e.layout=="list"){t=this.make("article",{"class":"drop base cf"});this.template=_.template($("#drop-list-view-template").html())}else if(e.layout=="photos"){t=this.make("article",{"class":"drop col_3 base"});this.template=_.template($("#drop-photos-view-template").html())}else{t=this.make("article",{"class":"drop base masonry-brick"});this.template=_.template($("#drop-drops-view-template").html())}this.setElement(t);this.model.on("change:user_score",this.updateDropScore,this);this.model.on("change:comment_count",this.render,this);this.model.on("change:buckets",this.updateBucketCount,this)},make:function(e,t){var n=document.createElement(e);t&&$(n).attr(t);return n},render:function(e){var t=this.template(this.model.toJSON());if(this.options.layout=="drops"){if(this.model.get("image")!=null){var n=_.template($("#drop-photos-view-template").html()),r=n({image:this.model.get("image")});this.$el.html(r)}}else if(this.options.layout=="photos"){var i=_.template($("#drop-drops-view-template").html());dropContent=i(this.model.toJSON());this.model.get("image")!=null&&this.$el.html(t);t=dropContent}this.$el.append(t);return this},showDetail:function(){this.options.router.navigate("/drop/"+this.model.get("id")+"/zoom",{trigger:!0});return!1}}),d=Drops.DropDetailView=h.extend({tagName:"article",className:"modal drop drop-full",isFetching:!1,lastId:Math.pow(2,32)-1,isAtLastPage:!1,maxId:0,renderDiscussionCollection:!1,isPollingStarted:!1,isSyncing:!1,events:{"click #add-comment a.button-primary":"addComment","click li.bucket a.modal-trigger":"showAddToBucketModal","click ul.score-drop > li.star a":"likeDrop","click ul.score-drop > li.remove a":"dislikeDrop","click li.share > a":"shareDrop","click #discussions_next_page":"loadComments","click #new_comments_alert a":"showNewComments","click a.button-prev":"showPrevDrop","click a.button-next":"showNextDrop"},initialize:function(e){this.template=_.template($("#drop-detail-template").html());if(this.model.has("discussion_collection")){this.discussions=this.model.get("discussion_collection");this.renderDiscussionCollection=!0}else{this.discussions=new n;this.discussions.url=e.baseURL+"/comments/"+this.model.get("id");this.model.set("discussion_collection",this.discussions);this.loadComments()}this.discussions.on("add",this.addDiscussion,this);this.model.on("change:user_score",this.updateDropScore,this);this.newComments=new n;this.newComments.url=e.baseURL+"/comments/"+this.model.get("id");this.newComments.on("add",this.alertNewComments,this);this.newComments.on("reset",this.resetNewCommentsAlert,this)},render:function(e){this.$el.html(this.template(this.model.toJSON()));this.renderDiscussionCollection&&this.discussions.each(this.addDiscussion,this);var t=new f;t.url=this.options.baseURL+"/places/"+this.model.get("id");t.reset(this.model.get("places"));this.addMetadataBlock(t);var n=new u;n.url=this.options.baseURL+"/links/"+this.model.get("id");n.reset(this.model.get("links"));this.addMetadataBlock(n);var r=new s;r.url=this.options.baseURL+"/tags/"+this.model.get("id");r.reset(this.model.get("tags"));this.addMetadataBlock(r);return this},addDiscussion:function(e){if(parseInt(e.get("id"))<this.lastId||!this.lastId)this.lastId=parseInt(e.get("id"));parseInt(e.get("id"))>this.maxId&&(this.maxId=parseInt(e.get("id")));this.discussions.length>=20&&this.$(".drop-discussion").parent().show();var t=new r({model:e});e.view=t;var n=this.discussions.indexOf(e);n>0?this.discussions.at(n-1).view.$el.before(t.render().el):this.$(".drop-discussion").prepend(t.render().el)},addComment:function(e){var t=this.$("#add-comment textarea");if(!$(t).val().length)return!1;var n=this.$("#add-comment .drop-actions a").clone(),r=window.loading_message.clone();this.$("#add-comment .drop-actions a").replaceWith(r);var i=this.model;this.discussions.create({comment_text:$(t).val()},{wait:!0,complete:function(){r.replaceWith(n)},success:function(e,n){t.val("");i.set("comment_count",parseInt(i.get("comment_count"))+1)},error:function(e,t){showConfirmationMessage("Unable to add comment. Try again later.")}});return!1},addMetadataBlock:function(e,t,n){var r=new E({collection:e,model:this.model});this.$("#metadata").append(r.render().el)},doPollComments:function(){this.isPollingStarted=!0;view=this;var e=setTimeout(function(){view.isSyncing?view.doPollComments():view.newComments.fetch({data:{since_id:view.maxId},add:!0,complete:function(){view.$el.is(":visible")&&view.doPollComments()}})},6e4+Math.floor(Math.random()*6e4+1))},alertNewComments:function(e){parseInt(e.get("id"))>this.maxId&&(this.maxId=parseInt(e.get("id")));var t=this.newComments.length+" new comment"+(this.newComments.length>1?"s":"");this.$("#new_comments_alert span.message").html(t);this.$("#new_comments_alert").show()},resetNewCommentsAlert:function(){this.$("#new_comments_alert").fadeOut("slow",function(){$(this).find("span.message").html("")})},showNewComments:function(){if(this.isSyncing)return;this.isSyncing=!0;this.discussions.add(this.newComments.models);this.newComments.reset();this.isSyncing=!1;return!1},loadComments:function(){if(this.isFetching||this.isAtLastPage)return!1;this.isFetching=!0;view=this;this.discussions.fetch({data:{last_id:view.lastId},update:!0,complete:function(e,t){setTimeout(function(){view.isFetching=!1},700);view.isPollingStarted||view.doPollComments()},error:function(e,t){if(t.status==404){view.isAtLastPage=!0;var n=view.$("#no_comments_alert");view.discussions.length&&view.$("section.drop-discussion p.button-white").parent().replaceWith(n.show())}}});return!1},showFullDrop:function(){this.options.router.navigate("/drop/"+this.model.get("id"),{trigger:!0});return!1},showPrevDrop:function(){this.model.prev&&this.options.router.navigate("/drop/"+this.model.prev.get("id")+"/zoom",{trigger:!0});return!1},showNextDrop:function(){this.model.next&&this.options.router.navigate("/drop/"+this.model.next.get("id")+"/zoom",{trigger:!0});return!1}}),v=Drops.BucketView=Backbone.View.extend({tagName:"li",className:"static cf",events:{"click span.select":"toggleBucket"},initialize:function(){this.template=_.template($("#bucket-template").html())},render:function(){var e=this.model,t=this.options.drop.get("buckets"),n=typeof _.find(t,function(t){return t["id"]==e.get("id")})!="undefined";n&&this.$el.addClass("selected");this.$el.html(this.template(e.toJSON()));return this},setSelected:function(){this.$el.addClass("selected")},toggleBucket:function(){this.options.drop.setBucket(this.model);this.$el.hasClass("selected")?this.$el.removeClass("selected"):this.$el.addClass("selected")}}),m=Drops.AddToBucketView=Assets.BaseModalAssetListView.extend({tagName:"article",className:"modal",listSelector:".select-list",listItemSelector:".select-list label",initialize:function(e){this.template=_.template($("#add-to-bucket-template").html());this.$el.html(this.template(this.model.toJSON()));Assets.BaseAssetListView.prototype.initialize.call(this,e)},getView:function(e){return new v({model:e,drop:this.model})},renderAsset:function(e){return e.get("is_owner")},onSaveNewBucket:function(e){this.model.isInBucket(e)||this.model.setBucket(e)}}),g=Backbone.View.extend({tagName:"article",className:"stream-message",events:{"click a":"onClick"},initialize:function(e){this.template=_.template($("#new-drops-template").html())},render:function(){var e={count:this.collection.size()};this.$el.html(this.template(e)).show();return this},onClick:function(){this.trigger("click");return!1}}),y=Drops.DropsView=Backbone.View.extend({noContentElHidden:!1,initialize:function(e){this.template=_.template($("#drop-listing-template").html());e.dropsList.on("reset",this.initDrops,this);e.dropsList.on("destroy",this.checkEmpty,this);if(e.layout=="list"){e.dropsList.on("add",this.addDrop,this);this.setElement(this.make("div",{"class":"river list"}))}else{e.dropsList.on("drops",this.addDrops,this);this.setElement(this.make("div",{"class":"river drops",style:"position:relative;"}))}e.newDropsList.on("add",this.alertNewDrops,this);e.newDropsList.on("reset",this.resetNewDropsAlert,this);e.filters.on("change",this.filtersUpdated,this)},make:function(e,t,n){var r=document.createElement(e);t&&$(r).attr(t);n&&$(r).html(n);return r},render:function(){this.$el.html(this.template());this.alertNewDrops();return this},addDrops:function(e){var t=this,n=[],r=this.options.maxId;_.each(e,function(e){r=Math.max(r,e.get("id"));n.push((new p({model:e,layout:this.options.layout,baseURL:t.options.baseURL,router:t.options.router})).render().el)},this);var i=$(n).css({opacity:0}),s=this.$("#drops-view");r>this.options.maxId?s.prepend(i):s.append(i);i.imagesLoaded(function(){i.animate({opacity:1});r>t.options.maxId?s.masonry("reload"):s.masonry("appended",$(n),!0)})},addDrop:function(e){var t=new p({model:e,layout:this.options.layout,baseURL:this.options.baseURL,router:this.options.router});e.view=t;var n=this.options.dropsList.indexOf(e),r=this.options.dropsList.length-1;if(r>0){e.prev=n>0?this.options.dropsList.at(n-1):this.options.dropsList.at(r);e.next=n==r?this.options.dropsList.at(0):this.options.dropsList.at(n+1);e.prev.next=e;e.next.prev=e}else{e.prev=null;e.next=null}if(this.options.layout=="list"){var i=this.options.dropsList.indexOf(e);i>0?this.options.dropsList.at(i-1).view.$el.before(t.render().el):this.$("#drops-view").append(t.render().el)}else{t.render().$el.css({opacity:0});this.$("#drops-view").prepend(t.el)}this.noContentElHidden||this.hideNoContentEl()},initDrops:function(){this.$("article.drop").remove();var e=!1;if(this.$("#drops-view").hasClass("masonry-brick")){this.$("#drops-view").masonry("destroy");e=!0}if(!this.checkEmpty()){this.hideNoContentEl();this.options.dropsList.each(this.addDrop,this)}e&&this.masonry()},masonry:function(){var e=this.$("#drops-view"),t=this;e.imagesLoaded(function(){t.$("article.drop").animate({opacity:1});if(t.options.layout=="drops"||t.options.layout=="photos")window.innerWidth>=615&&window.innerWidth<=960?e.masonry({itemSelector:"article.drop",isAnimated:!Modernizr.csstransitions,columnWidth:function(e){return e/2}}):window.innerWidth>=960&&e.masonry({itemSelector:"article.drop",isAnimated:!Modernizr.csstransitions,columnWidth:function(e){return e/3}})})},hideNoContentEl:function(){this.$(".no-content").hide();this.noContentElHidden=!0},checkEmpty:function(){if(!this.options.dropsList.length){var e=this.$(".no-content");this.$el.remove();$("#content").removeClass("river").addClass("cf").append(e);e.show();this.noContentElHidden=!1;return!0}return!1},alertNewDrops:function(){var e=this.options.newDropsList.size();if(e>0){if(this.alertView==undefined){this.alertView=new g({collection:this.options.newDropsList});this.alertView.on("click",this.showNewDrops,this)}this.alertView.render().$el.prependTo(this.$el).fadeIn("slow")}},showNewDrops:function(){var e=this,t=this.options.dropsList,n=this.options.newDropsList;e.alertView.$el.fadeOut("slow",function(){e.alertView.$el.remove();delete e.alertView;t.add(n.models);n.reset()})},resetNewDropsAlert:function(){this.$("article.alert-message").fadeOut("slow").remove()},getFilters:function(){return this.options.filters}}),b=Backbone.View.extend({tagName:"li",events:{"click span.remove":"removeMeta"},initialize:function(){this.template=_.template($("#edit-metadata-item-template").html())},render:function(){var e="";metadata=this.model;metadata instanceof i?e=metadata.get("tag"):metadata instanceof o?e=metadata.get("url"):metadata instanceof a&&(e=metadata.get("name"));this.$el.html(this.template({label:e}));return this},setSelected:function(){this.$el.addClass("selected")},removeMeta:function(){this.model.destroy();this.$el.fadeOut("slow");return!1}}),w=Backbone.View.extend({tagName:"article",className:"modal",events:{"click .modal-toolbar a.button-submit":"saveNewMetadata",submit:"saveNewMetadata","keyup .modal-field input":"keypressSave"},initialize:function(){this.template=_.template($("#edit-metadata-template").html());this.collection.on("add",this.addMetadata,this)},addMetadata:function(e){var t=new b({model:e});this.$(".view-table ul").prepend(t.render().el);e.view=t;return!1},render:function(){var e=this.model.toJSON(),t=null;if(this.collection instanceof s){e.label="Tags";t=_.template($("#add-tag-template").html())}else if(this.collection instanceof u){e.label="Links";t=_.template($("#add-link-template").html())}else this.collection instanceof f&&(e.label="Places");this.$el.html(this.template(e));this.collection.each(this.addMetadata,this);t!=null&&this.$(".modal-tabs-container").prepend(t());return this},isPageFetching:!1,saveNewMetadata:function(){var e=$.trim(this.$(".modal-field input[name=new_metadata]").val()),t=this.$(".modal-field select[name=tag_type]").val();if(!e.length||this.isPageFetching)return!1;var n=this.collection.find(function(n){if(n instanceof i)return n.get("tag").toLowerCase()==e.toLowerCase()&&n.get("type").toLowerCase==t.toLowerCase();if(n instanceof o)return n.get("url").toLowerCase()==e;if(n instanceof a)return n.get("name").toLowerCase()==e.toLowerCase()});if(n){var r=n.view.$el.offset().top-this.$(".view-table ul").offset().top;(r<0||r>this.$(".view-table ul").height())&&this.$(".view-table ul").animate({scrollTop:this.$(".view-table ul").scrollTop()+r},600);this.$("a.modal-back").trigger("click");n.view.setSelected();this.$(".modal-field input[name=new_metadata]").val("");this.isPageFetching=!1;return!1}var l=window.loading_message.clone(),c=this.$(".create-new .field").clone();this.$(".create-new .field").replaceWith(l);this.collection instanceof s?n=new i({tag:e,tag_type:t}):this.collection instanceof u?n=new o({url:e}):this.collection instanceof f&&(n=new a({name:e}));var h=this;this.collection.create(n,{wait:!0,complete:function(){h.isPageFetching=!1;l.replaceWith(c)},error:function(e,t){var n="";if(t.status==400){errors=JSON.parse(t.responseText).errors;_.each(errors,function(e){n+="<li>"+e+"</li>"})}else n="Oops something went wrong. Try again later.";flashMessage(h.$(".system_error"),n)},success:function(){h.$(".view-table ul").animate({scrollTop:h.$(".view-table ul").scrollTop()+(h.$(".view-table ul li").last().offset().top-h.$(".view-table ul").offset().top)},600);h.$("a.modal-back").trigger("click");h.$(".view-table ul li").removeClass("selected");n.view.setSelected();h.$(".modal-field input[name=new_metadata]").val("")}});return!1},keypressSave:function(e){if(e.which==13){this.saveNewMetadata();return!1}}}),E=Backbone.View.extend({tagName:"div",className:"filters-type",isInitialRender:!0,events:{"click .filters-type-settings a":"showEditMetadata"},initialize:function(){this.template=_.template($("#metadata-template").html());this.collection.on("add",this.addMetadata,this);this.collection.on("remove",this.removeMetadata,this);var e=this;this.collection.each(function(t){t.on("destroy",function(){e.collection.remove(t)})},this)},render:function(){var e="";this.collection instanceof f?e="Places":this.collection instanceof s?e="Tags":this.collection instanceof u&&(e="Links");var t={label:e,count:this.collection.length};this.$el.html(this.template(t));this.collection.each(this.addMetadata,this);this.initialRender=!1;return this},addMetadata:function(e){var t=new S({model:e});this.$(".filters-type-details ul").append(t.render().el);e.itemView=t;this.initialRender||this.updateMetadataCount()},showEditMetadata:function(){var e=new w({model:this.model,collection:this.collection});modalShow(e.render().el);return!1},updateMetadataCount:function(){this.$("span.total").html(this.collection.length)},removeMetadata:function(e){e.itemView.$el.fadeOut("slow");this.updateMetadataCount()}}),S=Backbone.View.extend({tagName:"li",initialize:function(e){this.template=_.template($("#metadata-item-template").html());var t=this;this.model.on("destroy",function(){t.$el.fadeOut("slow")})},render:function(){var e="";this.model instanceof i?e=this.model.get("tag"):this.model instanceof a?e=this.model.get("name"):this.model instanceof o&&(e=this.model.get("url"));this.$el.html(this.template({metadataText:e}));return this}}),x=Drops.DropFullView=Backbone.View.extend({tagName:"article",className:"drop drop-full cf",initialize:function(e){this.template=_.template($("#drop-full-view-template").html())},render:function(){this.$el.html(this.template());this.$el.attr("id","content");var e=new d({model:this.model,baseURL:this.options.baseURL,router:this.options.router});this.$el.append(e.render().el);window.fullView=this;return this}}),T=Backbone.View.extend({tagName:"article",className:"modal",events:{"click a#share-email":"showEmailForm"},initialize:function(e){this.template=_.template($("#share-drop-template").html())},showEmailForm:function(){var e=new N({model:this.model,baseURL:this.options.baseURL});this.$("#modal-secondary").html(e.render().el)},render:function(){var e=this.model.toJSON();e.drop_url=site_url.substring(0,site_url.length-1)+this.options.baseURL+"/drop/"+e.id;this.$el.html(this.template(e));return this}}),N=Backbone.View.extend({tagName:"div",className:"modal-segment",events:{"click .modal-toolbar a.button-submit":"sendEmail"},initialize:function(e){this.template=_.template($("#email-share-template").html());this.dropURL=site_url.substring(0,site_url.length-1)+this.options.baseURL+"/drop/"+this.model.get("id");this.hasSubmitted=!1},sendEmail:function(){var e={drop_title:this.model.get("title"),drop_url:this.dropURL};$(":input",this.$("form")).each(function(t){e[$(this).attr("name")]=$(this).val()});if(!this.hasSubmitted){this.hasSubmitted=!0;this.$("#error").hide();var t=window.loading_message.clone(),n=this.$(".modal-toolbar a.button-submit");this.$(".modal-toolbar a.button-submit").replaceWith(loading_message);var r=this;$.ajax({url:this.options.baseURL+"/share",type:"POST",data:e,success:function(e){r.$("#success").show();r.$(loading_message).replaceWith(n);r.hasSubmitted=!1;setTimeout(function(){r.$("a.modal-back").trigger("click")},1800)},error:function(){r.$("#error").show();r.hasSubmitted=!1;r.$(loading_message).replaceWith(n)},dataType:"json"})}return!1},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}}),C=Drops.DropsStateFilterView=Backbone.View.extend({el:"#drops-state-filter",events:{"click a":"onClick"},initialize:function(e){e.dropsList.on("all",this.renderTotals,this);e.dropFilters.on("all",this.renderTotals,this);this.render()},onClick:function(e){var t=$(e.target);if(!t.parents("li").hasClass("active")){t.parents("li").addClass("active");t.parents("li").siblings("li").removeClass("active");t.parents("li").hasClass("read")?filters.set("state","read"):filters.set("state","unread")}else{t.parents("li").removeClass("active");filters.unset("state")}return!1},render:function(){var e=this.options.dropFilters;this.$(".read,.unread").removeClass("active");if(e.has("state")){var t=e.get("state");this.$("."+t).addClass("active")}this.renderTotals();return this},renderTotals:function(){this.$("li.read .total").html(this.options.dropsList.getRead().length);this.$("li.unread .total").html(this.options.dropsList.getUnread().length)}})})(this);